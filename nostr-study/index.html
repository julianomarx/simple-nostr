<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <script src="https://bundle.run/browserify-cipher@1.0.1"></script>
        <script src="https://bundle.run/noble-secp256k1@1.2.14"></script>
    </head>    

    <body>
        <script>
            // funções basicas de conversão

            var hexToBytes = hex => Uint8Array.from( hex.match( /.{1,2}/g ).map( byte => parseInt( byte, 16 ) ) );
            var bytesToHex = bytes => bytes.reduce( ( str, byte ) => str + byte.toString( 16 ).padStart( 2, "0" ), "" );



            // gerando par de chaves  - PASSANDO UM RANDOM - Porém já funciona com o hex privado


            var { getSharedSecret, schnorr, utils } = nobleSecp256k1;
            var sha256  = nobleSecp256k1.utils.sha256;
            var privKey = bytesToHex(nobleSecp256k1.utils.randomPrivateKey() ); 
            var pubKey  = nobleSecp256k1.getPublicKey(privKey, true);
            pubKey      = pubKey.substring( 2 );
            console.log(privKey, pubKey)


            //conexão websocket com o relay

            var relay = "wss://relay.bitcreekwallet.org/";
            var socket = new WebSocket( relay )


            // ouvir eventos tipo 4 

            socket.addEventListener('message', async function( message ) {
                var [ type, subId, event ] = JSON.parse( message.data );
                var { kind, content } = event || {}
                if (!event || event === true) return;
                console.log('message:', event);
                if (kind === 4) {
                  content = await decrypt(privKey, event.pubkey, content);
                }
                console.log('content:', content);
            });



            socket.addEventListener('open', async function( e ) {
                console.log( "connected to " + relay );


                var subId   = bytesToHex( nobleSecp256k1.utils.randomPrivateKey() ).substring( 0, 16 );
                var filter  = { "authors": [ pubKey ] }
                var subscription = [ "REQ", subId, filter ]
                console.log('Subscription:', subscription);
                socket.send(JSON.stringify( subscription ));



                //put this stuff in the “open” event listener from earlier
                var event = {
                    "content"    : "this workshop is awesome!",
                    "created_at" : Math.floor( Date.now() / 1000 ),
                    "kind"       : 1,
                    "tags"       : [],
                    "pubkey"     : pubKey,
                }
    
                var signedEvent = await getSignedEvent(event, privKey);
                console.log('signedEvent:', signedEvent);
                socket.send(JSON.stringify([ "EVENT", signedEvent ]));
            }); //close this bracket, but we’ll put more stuff in here later


            //put this right above your closing script tag
            async function getSignedEvent(event, privateKey) {
                var eventData = JSON.stringify([
                    0,                    // Reserved for future use
                    event['pubkey'],      // The sender's public key
                    event['created_at'],  // Unix timestamp
                    event['kind'],        // Message “kind” or type
                    event['tags'],        // Tags identify replies/recipients
                    event['content']      // Your note contents
                ]);
            
                event.id  = bytesToHex( await sha256( ( new TextEncoder().encode( eventData ) ) ) );
                event.sig = await schnorr.sign( event.id, privateKey );
                return event;
            }

        </script>
    </body>
    
</html>